<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Connection Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #0a0a1a;
            color: #fff;
        }

        .test-card {
            background: rgba(15, 15, 32, 0.8);
            border: 1px solid rgba(0, 212, 255, 0.2);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
        }

        h1 {
            color: #00d4ff;
            text-align: center;
        }

        button {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        button:hover {
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .result {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .success {
            color: #00ff88;
        }

        .error {
            color: #ff4444;
        }

        .info {
            color: #ffbb00;
        }
    </style>
</head>

<body>
    <h1>üîß Supabase Connection Test</h1>

    <div class="test-card">
        <h2>Step 1: Test Connection</h2>
        <button onclick="testConnection()">Test Supabase Connection</button>
        <div id="connection-result" class="result"></div>
    </div>

    <div class="test-card">
        <h2>Step 2: Test Admin Login</h2>
        <button onclick="testAdminLogin()">Test Admin Login</button>
        <div id="login-result" class="result"></div>
    </div>

    <div class="test-card">
        <h2>Step 3: Check Database Tables</h2>
        <button onclick="checkTables()">Check Tables</button>
        <div id="tables-result" class="result"></div>
    </div>

    <div class="test-card">
        <h2>Step 4: Test RLS Policies</h2>
        <button onclick="testRLS()">Test Row Level Security</button>
        <div id="rls-result" class="result"></div>
    </div>

    <!-- Supabase CDN - Must load before our scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="module">
        import { supabase } from './scripts/supabase-client.js';

        // Make Supabase available globally for tests
        window.supabase = supabase;

        window.testConnection = async function () {
            const result = document.getElementById('connection-result');
            result.innerHTML = 'Testing connection...';

            try {
                // Just test if Supabase client is initialized
                const { data: { session } } = await supabase.auth.getSession();

                // Try to access participants (will fail if not authenticated - this is good!)
                const { data, error } = await supabase.from('participants').select('count');

                if (error && (error.code === '42501' || error.message.includes('row-level security'))) {
                    // RLS is working! This is expected and good
                    result.innerHTML = `<span class="success">‚úÖ Supabase connected successfully!</span>\n<span class="info">üîí Row Level Security is ACTIVE (this is good!)</span>\nYou need to login to access data.`;
                } else if (error) {
                    result.innerHTML = `<span class="info">‚ö†Ô∏è Connected but got error:</span>\n${error.message}\n\nThis might be expected if RLS is enabled.`;
                } else {
                    result.innerHTML = `<span class="success">‚úÖ Connected successfully!</span>\nSupabase is working correctly.`;
                }
            } catch (e) {
                result.innerHTML = `<span class="error">‚ùå Connection Error:</span>\n${e.message}\n\nMake sure your credentials are correct in supabase-client.js`;
            }
        };

        window.testAdminLogin = async function () {
            const result = document.getElementById('login-result');
            result.innerHTML = 'Testing admin login...';

            try {
                // First, sign out if already signed in
                await supabase.auth.signOut();

                // Try to login with admin credentials
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'admin@codebeyond.event',
                    password: 'CodeBeyond2025!'
                });

                if (error) {
                    result.innerHTML = `<span class="error">‚ùå Login failed:</span>\n${error.message}`;
                } else {
                    const role = data.user.user_metadata?.role || 'no role set';
                    result.innerHTML = `<span class="success">‚úÖ Admin login successful!</span>\nEmail: ${data.user.email}\nRole: ${role}`;
                }
            } catch (e) {
                result.innerHTML = `<span class="error">‚ùå Error:</span>\n${e.message}`;
            }
        };

        window.checkTables = async function () {
            const result = document.getElementById('tables-result');
            result.innerHTML = 'Checking database tables...';

            try {
                // Check participants table
                const { count: participantsCount, error: p_error } = await supabase
                    .from('participants')
                    .select('*', { count: 'exact', head: true });

                // Check team_members table
                const { count: membersCount, error: m_error } = await supabase
                    .from('team_members')
                    .select('*', { count: 'exact', head: true });

                if (p_error || m_error) {
                    result.innerHTML = `<span class="error">‚ùå Table check failed:</span>\n${p_error?.message || m_error?.message}`;
                } else {
                    result.innerHTML = `<span class="success">‚úÖ Tables found!</span>\nParticipants: ${participantsCount || 0} records\nTeam Members: ${membersCount || 0} records`;
                }
            } catch (e) {
                result.innerHTML = `<span class="error">‚ùå Error:</span>\n${e.message}`;
            }
        };

        window.testRLS = async function () {
            const result = document.getElementById('rls-result');
            result.innerHTML = 'Testing Row Level Security...';

            try {
                // Sign out first
                await supabase.auth.signOut();

                // Try to access participants table without auth
                const { data: unauthData, error: unauthError } = await supabase
                    .from('participants')
                    .select('*')
                    .limit(1);

                if (unauthError || !unauthData || unauthData.length === 0) {
                    result.innerHTML = `<span class="success">‚úÖ RLS is working!</span>\nUnauthenticated users cannot access data (as expected).`;
                } else {
                    result.innerHTML = `<span class="info">‚ö†Ô∏è RLS might not be enabled</span>\nUnauthenticated access returned data. This might be expected if there's public data.`;
                }
            } catch (e) {
                result.innerHTML = `<span class="error">‚ùå Error:</span>\n${e.message}`;
            }
        };

        // Auto-test connection on page load
        window.addEventListener('load', () => {
            testConnection();
        });
    </script>
</body>

</html>