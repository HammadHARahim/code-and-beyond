// ========================================
// SUPABASE INTEGRATION - FIXED VERSION
// ========================================
import { supabase } from './supabase-client.js';

// Form Submit Handler - SUPABASE VERSION WITH EMAIL CONFIRMATION FIX
const registerForm = document.getElementById('register-form');

registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Get password values
    const email = document.getElementById('email').value.trim();
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;

    // Validate password strength
    const strength = checkPasswordStrength(password);
    if (!strength || strength === 'weak') {
        alert('Please use a stronger password. Your password should be at least 8 characters long and include uppercase, lowercase, and numbers.');
        return;
    }

    // Validate password match
    if (password !== confirmPassword) {
        alert('Passwords do not match. Please check and try again.');
        return;
    }

    const accommodationRequired = document.querySelector('input[name="accommodation"]:checked')?.value === 'yes';

    const participantData = {
        team_name: document.getElementById('team-name').value,
        team_lead: document.getElementById('team-lead').value,
        university: document.getElementById('university').value,
        department: document.getElementById('department').value,
        phone: document.getElementById('phone').value,
        team_size: parseInt(document.getElementById('team-size').value),
        accommodation_needed: accommodationRequired,
        accommodation_type: accommodationRequired ? document.getElementById('accommodation-type').value : null,
        accommodation_duration: accommodationRequired ? document.getElementById('accommodation-duration').value : null,
        special_requirements: accommodationRequired ? document.getElementById('special-requirements').value : null,
        project_title: document.getElementById('project-title').value,
        project_category: document.getElementById('category').value,
        project_description: document.getElementById('description').value,
        problem_solved: document.getElementById('problem-solved').value,
        tech_stack: document.getElementById('tech-stack').value,
        project_url: document.getElementById('project-url').value || null,
        video_url: document.getElementById('video-url').value || null
    };

    const teamMembers = collectTeamMembers();

    try {
        // Show loading state
        const submitBtn = registerForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Registering...';

        // Step 1: Create Supabase auth user with autoConfirm option
        const { data: authData, error: authError } = await supabase.auth.signUp({
            email,
            password,
            options: {
                data: {
                    role: 'participant'
                },
                emailRedirectTo: window.location.origin + '/pages/login.html'
            }
        });

        if (authError) {
            console.error('Auth error:', authError);
            alert(`Registration failed: ${authError.message}`);
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }

        // Check if session exists (email confirmation might be required)
        if (!authData.session) {
            // Email confirmation is required
            alert('Registration successful! Please check your email to confirm your account, then you can login.');
            window.location.href = 'login.html';
            return;
        }

        // Step 2: Insert participant data (only if session exists)
        participantData.user_id = authData.user.id;

        const { data: participantRecord, error: participantError } = await supabase
            .from('participants')
            .insert([participantData])
            .select()
            .single();

        if (participantError) {
            console.error('Participant error:', participantError);
            
            // If it's an RLS error, the user was created but data wasn't saved
            if (participantError.code === '42501') {
                alert('Account created but profile setup failed. Please login and contact support.');
            } else {
                alert(`Failed to save registration: ${participantError.message}`);
            }
            
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
        }

        // Step 3: Insert team members if any
        if (teamMembers.length > 0) {
            const teamMemberRecords = teamMembers.map(member => ({
                participant_id: participantRecord.id,
                member_name: member.name,
                member_email: member.email,
                member_role: member.department
            }));

            const { error: membersError } = await supabase
                .from('team_members')
                .insert(teamMemberRecords);

            if (membersError) {
                console.error('Team members error:', membersError);
                // Don't fail the whole registration, just log it
                console.warn('Team members not saved, but registration successful');
            }
        }

        console.log('Registration successful:', authData.user.email);

        // Show success message and redirect
        alert('Registration completed successfully! You can now login with your credentials.');
        window.location.href = 'login.html';

    } catch (error) {
        console.error('Unexpected error during registration:', error);
        alert('An unexpected error occurred. Please try again.');
        
        const submitBtn = registerForm.querySelector('button[type="submit"]');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Complete Registration';
    }
});
